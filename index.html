<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIC Simple Store</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        /* Custom scrollbar */
        .scrollable-content::-webkit-scrollbar {
            width: 8px;
        }
        .scrollable-content::-webkit-scrollbar-track {
            background: #e2e8f0; /* bg-gray-200 */
            border-radius: 10px;
        }
        .scrollable-content::-webkit-scrollbar-thumb {
            background: #9ca3af; /* bg-gray-400 */
            border-radius: 10px;
        }
        .scrollable-content::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }
        /* Modal Overlays (Quantity, Message) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 60;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease-out, visibility 0.2s ease-out;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
            text-align: center;
            transform: scale(0.95);
            transition: all 0.2s ease-out;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
    </style>
    <!-- Firebase CDN (Make sure to use the latest compatible versions) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        // Import documentId here for querying by document ID
        import { getFirestore, collection, getDocs, addDoc, setDoc, doc, query, where, serverTimestamp, documentId } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Global variables for Firebase services
        window.firebaseApp = null;
        window.firebaseAuth = null;
        window.firebaseDb = null;
        window.currentFirebaseUserId = null; // Stores the UID from signInAnonymously()
        // Expose documentId for global use in custom functions if needed (e.g., duplicateOrderToCart)
        window.documentId = documentId;

        // Firebase configuration (provided by Canvas environment)
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Use default if not provided

        // Initialize Firebase
        if (Object.keys(firebaseConfig).length > 0) {
            window.firebaseApp = initializeApp(firebaseConfig);
            window.firebaseAuth = getAuth(window.firebaseApp);
            window.firebaseDb = getFirestore(window.firebaseApp);

            // Listen for auth state changes
            onAuthStateChanged(window.firebaseAuth, (user) => {
                if (user) {
                    window.currentFirebaseUserId = user.uid;
                    console.log("Firebase user signed in:", user.uid);
                    // No need to update UI here, login handlers will do it
                } else {
                    window.currentFirebaseUserId = null;
                    console.log("Firebase user signed out or not authenticated anonymously.");
                }
            });

            // Sign in anonymously on load if not already signed in
            if (!window.firebaseAuth.currentUser) {
                 signInAnonymously(window.firebaseAuth)
                    .then(() => console.log("Signed in anonymously."))
                    .catch((error) => console.error("Anonymous sign-in error:", error));
            }
        } else {
            console.warn("Firebase configuration not found. Firestore operations will not work.");
        }

        // Expose Firestore collections for easier access
        window.getProductsCollection = () => collection(window.firebaseDb, `artifacts/${appId}/public/data/products`);
        window.getCustomersCollection = () => collection(window.firebaseDb, `artifacts/${appId}/public/data/customers`);
        // Orders collection path changes based on customerCode
        window.getOrdersCollection = (customerCode) => collection(window.firebaseDb, `artifacts/${appId}/public/data/orders/${customerCode}/customerOrders`);

        // Seed initial products if the collection is empty
        window.seedInitialData = async () => {
            if (!window.firebaseDb) {
                console.error("Firestore not initialized for seeding.");
                return;
            }

            const productsRef = window.getProductsCollection();
            const productDocs = await getDocs(productsRef);

            if (productDocs.empty) {
                console.log("Seeding initial product data...");
                const initialProducts = [
                    { id: 'p1', name: 'Premium Coffee Beans', description: 'Rich, aromatic, ethically sourced coffee beans.', price: 12.99, sku: 'CB001', category: 'Tea', tiHi: '10x10', caseWeight: 20, containerType: 'Bag' },
                    { id: 'p2', name: 'Organic Green Tea', description: 'Delicate and refreshing green tea, 20 tea bags.', price: 8.50, sku: 'GT002', category: 'Tea', tiHi: '8x8', caseWeight: 5, containerType: 'Tetra' },
                    { id: 'p3', name: 'Artisan Dark Chocolate', description: '70% cocoa dark chocolate bar, 100g.', price: 5.75, sku: 'DC003', category: 'Other', tiHi: '12x12', caseWeight: 10, containerType: 'Other' },
                    { id: 'p4', name: 'Gourmet Honey (Wildflower)', description: 'Pure wildflower honey, 500g jar.', price: 9.20, sku: 'HO004', category: 'Syrups', tiHi: '6x6', caseWeight: 15, containerType: 'Glass' },
                    { id: 'p5', name: 'Maple Syrup (Grade A)', description: 'Pure Grade A maple syrup, 250ml bottle.', price: 15.00, sku: 'MS005', category: 'Syrups', tiHi: '7x7', caseWeight: 18, containerType: 'Glass' },
                    { id: 'p6', name: 'Spiced Chai Mix', description: 'Instant chai latte mix, just add milk.', price: 7.99, sku: 'CM006', category: 'Tea', tiHi: '9x9', caseWeight: 7, containerType: 'Bag' },
                    { id: 'p7', name: 'Assorted Herbal Infusions', description: 'Selection of calming herbal teas, 15 bags.', price: 6.50, sku: 'HI007', category: 'Tea', tiHi: '5x5', caseWeight: 3, containerType: 'Tetra' },
                    { id: 'p8', name: 'Espresso Machine Cleaner', description: 'Eco-friendly descaling solution for espresso machines.', price: 10.99, sku: 'EMC008', category: 'Other', tiHi: '10x8', caseWeight: 12, containerType: 'PET' },
                    { id: 'p9', name: 'Strawberry Puree', description: 'Sweet strawberry puree, ideal for desserts and drinks.', price: 7.00, sku: 'PU001', category: 'Purees', tiHi: '8x6', caseWeight: 25, containerType: 'PET' },
                    { id: 'p10', name: 'Almond Milk (Unsweetened)', description: 'Dairy-free unsweetened almond milk.', price: 4.50, sku: 'AM001', category: 'Alternative to Milk', tiHi: '4x4', caseWeight: 30, containerType: 'Tetra' },
                    { id: 'p11', name: 'Vanilla Syrup', description: 'Classic vanilla flavored syrup for coffee and cocktails.', price: 9.99, sku: 'SYR001', category: 'Syrups', tiHi: '7x9', caseWeight: 17, containerType: 'Glass' },
                    { id: 'p12', name: 'Tropical Fruit Smoothie Base', description: 'Concentrated mix for delicious tropical smoothies.', price: 11.25, sku: 'SMO001', category: 'Smoothies', tiHi: '10x7', caseWeight: 22, containerType: 'PET' },
                ];
                for (const product of initialProducts) {
                    await setDoc(doc(productsRef, product.id), product);
                }
                console.log("Product seeding complete.");
            } else {
                console.log("Products already exist, skipping seeding.");
            }

            const customersRef = window.getCustomersCollection();
            const customerDocs = await getDocs(customersRef);

            if (customerDocs.empty) {
                console.log("Seeding initial test customer...");
                await addDoc(customersRef, {
                    name: "Test Customer",
                    customerCode: "140480",
                    password: "140480" // IMPORTANT: In production, HASH this password securely!
                });
                console.log("Test customer seeded.");
            } else {
                console.log("Customers already exist, skipping seeding.");
            }

            window.loadProductsFromFirestore(); // Load products after all seeding checks
        };
    </script>
</head>
<body class="min-h-screen flex flex-col">
    <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-bold rounded-md py-1 px-3 bg-blue-700 bg-opacity-70">GIC Store</h1>
            <nav class="flex items-center space-x-4">
                <button id="customerLoginTabButton" class="bg-white text-blue-600 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-100 transition duration-300">Customer Login</button>
                <button id="shopTabButton" class="bg-white text-blue-600 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-100 transition duration-300 hidden">Shop</button>
                <button id="myOrdersTabButton" class="bg-white text-blue-600 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-100 transition duration-300 hidden">My Orders</button>
                <button id="adminTabButton" class="bg-white text-blue-600 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-100 transition duration-300">Admin</button>
                <button id="cartButton" class="bg-white text-blue-600 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-100 transition duration-300 flex items-center hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    Cart (<span id="cartItemCount">0</span>)
                </button>
                <button id="customerLogoutButton" class="bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-600 transition duration-300 hidden">Logout</button>
            </nav>
        </div>
    </header>

    <main class="container mx-auto p-4 flex-grow">
        <!-- Customer Login Section -->
        <section id="customerLoginSection" class="active-section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Customer Login</h2>
            <div class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-8">
                <h3 class="text-2xl font-semibold text-gray-800 mb-4">Login to Access Products</h3>
                <div class="mb-4">
                    <label for="customerCodeInput" class="block text-gray-700 text-sm font-bold mb-2">Customer Code:</label>
                    <input type="text" id="customerCodeInput" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-6">
                    <label for="customerPasswordInput" class="block text-gray-700 text-sm font-bold mb-2">Password:</label>
                    <input type="password" id="customerPasswordInput" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button id="customerLoginButton" class="w-full bg-blue-500 text-white py-3 px-6 rounded-lg shadow-md hover:bg-blue-600 transition duration-300 font-semibold">Login</button>
                <p id="customerLoginMessage" class="text-red-500 text-sm mt-3 hidden"></p>
            </div>
        </section>

        <!-- Shop Section -->
        <section id="shopSection" class="hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Our Products</h2>
            <div class="mb-6 flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-4">
                <input type="text" id="productSearch" placeholder="Search products..." class="w-full sm:w-1/2 md:w-1/3 p-3 border-2 border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                <select id="categoryFilter" class="w-full sm:w-1/3 md:w-1/4 p-3 border-2 border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                    <option value="All">All Categories</option>
                    <option value="Syrups">Syrups</option>
                    <option value="Smoothies">Smoothies</option>
                    <option value="Alternative to Milk">Alternative to Milk</option>
                    <option value="Tea">Tea</option>
                    <option value="Purees">Purees</option>
                    <option value="Other">Other</option>
                </select>
                <button id="clearCartButton" class="w-full sm:w-auto bg-red-500 text-white py-2 px-4 rounded-lg shadow-md hover:bg-red-600 transition duration-300 font-semibold">Clear Cart</button>
            </div>
            <div id="productGrid" class="grid grid-cols-1 gap-4">
                <!-- Product list items will be loaded here by JavaScript -->
            </div>
        </section>

        <!-- My Orders Section -->
        <section id="myOrdersSection" class="hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">My Previous Orders (<span id="customerCodeDisplay"></span>)</h2>
            <div id="ordersList" class="space-y-6">
                <!-- Orders will be loaded here -->
                <p id="noOrdersMessage" class="text-center text-gray-600 text-lg hidden">You have no previous orders.</p>
            </div>
        </section>

        <!-- Admin Section -->
        <section id="adminSection" class="hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Admin Panel</h2>
            <div id="adminAuth" class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-8">
                <h3 class="text-2xl font-semibold text-gray-800 mb-4">Admin Login</h3>
                <div class="mb-4">
                    <label for="adminPassword" class="block text-gray-700 text-sm font-bold mb-2">Password:</label>
                    <input type="password" id="adminPassword" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button id="adminLoginButton" class="w-full bg-blue-500 text-white py-3 px-6 rounded-lg shadow-md hover:bg-blue-600 transition duration-300 font-semibold">Login</button>
                <p id="adminAuthMessage" class="text-red-500 text-sm mt-3 hidden">Incorrect password.</p>
            </div>

            <div id="adminContent" class="hidden mt-8 max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-8">
                <!-- Admin Sub-Navigation -->
                <div class="flex justify-center space-x-4 mb-8 border-b-2 border-gray-200 pb-4">
                    <button id="adminProductsTabButton" class="bg-blue-500 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-blue-600 transition duration-300">Manage Products</button>
                    <button id="adminCustomersTabButton" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-gray-300 transition duration-300">Manage Customers</button>
                </div>

                <!-- Product Management Section (Admin) -->
                <div id="adminProductSection" class="hidden">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-6">Add New Product</h3>
                    <form id="addProductForm" class="space-y-4">
                        <div>
                            <label for="newProductName" class="block text-gray-700 text-sm font-bold mb-2">Product Name:</label>
                            <input type="text" id="newProductName" required class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="newProductDescription" class="block text-gray-700 text-sm font-bold mb-2">Description:</label>
                            <textarea id="newProductDescription" rows="3" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                        <div>
                            <label for="newProductCategory" class="block text-gray-700 text-sm font-bold mb-2">Category:</label>
                            <select id="newProductCategory" required class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select a category</option>
                                <option value="Syrups">Syrups</option>
                                <option value="Smoothies">Smoothies</option>
                                <option value="Alternative to Milk">Alternative to Milk</option>
                                <option value="Tea">Tea</option>
                                <option value="Purees">Purees</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label for="newProductSKU" class="block text-gray-700 text-sm font-bold mb-2">SKU:</label>
                            <input type="text" id="newProductSKU" required class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="newProductTiHi" class="block text-gray-700 text-sm font-bold mb-2">TiHi:</label>
                            <input type="text" id="newProductTiHi" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="newProductCaseWeight" class="block text-gray-700 text-sm font-bold mb-2">Case Weight (lbs):</label>
                            <input type="number" id="newProductCaseWeight" step="0.01" value="0.00" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="flex items-end space-x-2">
                            <div class="flex-grow">
                                <label for="newProductContainerType" class="block text-gray-700 text-sm font-bold mb-2">Container Type:</label>
                                <select id="newProductContainerType" required class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                            <button type="button" id="addNewContainerTypeBtn" class="bg-blue-400 text-white py-2.5 px-4 rounded-lg shadow-md hover:bg-blue-500 transition duration-300 font-medium text-sm h-12">Add New</button>
                        </div>
                        
                        <div>
                            <label for="newProductPrice" class="block text-gray-700 text-sm font-bold mb-2">Price (for internal use/tracking):</label>
                            <input type="number" id="newProductPrice" step="0.01" value="0.00" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="flex space-x-4 mt-6">
                            <button type="submit" class="flex-1 bg-green-500 text-white py-3 px-6 rounded-lg shadow-md hover:bg-green-600 transition duration-300 font-semibold">Add Product</button>
                            <button type="button" id="discardProductBtn" class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-lg shadow-md hover:bg-gray-600 transition duration-300 font-semibold">Discard</button>
                        </div>
                        <p id="addProductMessage" class="text-green-600 text-sm mt-3 hidden"></p>
                    </form>
                </div>

                <!-- Customer Management Section (Admin) -->
                <div id="adminCustomerSection" class="hidden">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-6">Add New Customer</h3>
                    <form id="addCustomerForm" class="space-y-4">
                        <div>
                            <label for="newCustomerName" class="block text-gray-700 text-sm font-bold mb-2">Customer Name:</label>
                            <input type="text" id="newCustomerName" required class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="newCustomerCode" class="block text-gray-700 text-sm font-bold mb-2">Customer Code:</label>
                            <input type="text" id="newCustomerCode" required class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="newCustomerPassword" class="block text-gray-700 text-sm font-bold mb-2">Password:</label>
                            <input type="password" id="newCustomerPassword" required class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="flex space-x-4 mt-6">
                            <button type="submit" class="flex-1 bg-blue-500 text-white py-3 px-6 rounded-lg shadow-md hover:bg-blue-600 transition duration-300 font-semibold">Add Customer</button>
                            <button type="button" id="discardCustomerBtn" class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-lg shadow-md hover:bg-gray-600 transition duration-300 font-semibold">Discard</button>
                        </div>
                        <p id="addCustomerMessage" class="text-green-600 text-sm mt-3 hidden"></p>
                    </form>
                </div>
            </div>
        </section>

        <!-- Cart Modal / Sidebar -->
        <div id="cartModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 z-50 flex justify-end">
            <div class="bg-white w-full max-w-sm h-full shadow-lg p-6 flex flex-col rounded-l-lg transform transition-transform duration-300 ease-in-out translate-x-full" id="cartContent">
                <div class="flex justify-between items-center mb-4 pb-4 border-b border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-800">Your Cart</h2>
                    <button id="closeCartButton" class="text-gray-500 hover:text-gray-700 text-3xl font-light">&times;</button>
                </div>
                <div id="cartItems" class="flex-grow overflow-y-auto scrollable-content pr-2">
                    <!-- Cart items will be loaded here -->
                    <p class="text-gray-500 text-center mt-8" id="emptyCartMessage">Your cart is empty.</p>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <button id="placeOrderButton" class="w-full bg-green-500 text-white py-3 px-6 rounded-lg shadow-md hover:bg-green-600 transition duration-300 font-semibold">Place Order</button>
                </div>
            </div>
        </div>

        <!-- Quantity Selection Modal -->
        <div id="quantityModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Add <span id="quantityProductName"></span> to Cart</h3>
                <label for="quantityInput" class="block text-gray-700 text-sm font-bold mb-2">Quantity (Cases):</label>
                <input type="number" id="quantityInput" min="1" value="1" class="w-full p-3 border-2 border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-lg">
                <div class="flex justify-center space-x-4 mt-6">
                    <button id="quantityAddBtn" class="bg-blue-500 text-white py-2 px-5 rounded-lg shadow-md hover:bg-blue-600 transition duration-300 font-semibold">Add</button>
                    <button id="quantityCancelBtn" class="bg-gray-300 text-gray-800 py-2 px-5 rounded-lg shadow-md hover:bg-gray-400 transition duration-300 font-semibold">Cancel</button>
                </div>
                <p id="quantityError" class="text-red-500 text-sm mt-3 hidden">Please enter a valid quantity (1 or more).</p>
            </div>
        </div>

        <!-- Message Modal (for notifications) -->
        <div id="messageModal" class="modal-overlay">
            <div class="modal-content">
                <h3 id="messageTitle" class="text-xl font-semibold text-gray-800 mb-4"></h3>
                <p id="messageText" class="text-gray-700 mb-6"></p>
                <button id="messageCloseBtn" class="bg-blue-500 text-white py-2 px-5 rounded-lg shadow-md hover:bg-blue-600 transition duration-300 font-semibold">OK</button>
            </div>
        </div>

    </main>

    <footer class="bg-gray-800 text-white p-4 mt-8 shadow-inner">
        <div class="container mx-auto text-center text-gray-400">
            &copy; 2024 GIC Simple Store. All rights reserved.
        </div>
    </footer>

    <script type="module">
        // Import Firestore functions exposed globally by the first script tag
        // documentId is now explicitly imported from firebase/firestore
        const { getAuth, signInAnonymously, onAuthStateChanged, signOut } = window.firebaseAuth;
        const { getFirestore, collection, getDocs, addDoc, setDoc, doc, query, where, serverTimestamp, documentId } = window.firebaseDb;
        const { getProductsCollection, getCustomersCollection, getOrdersCollection, seedInitialData } = window; // Changed to seedInitialData

        let products = []; // All products from Firestore
        let cart = []; // Array to store cart items: { product: product_object, quantity: number }
        let currentLoggedInCustomerCode = null; // Stores the code of the customer who logged in

        // For Container Type dropdown
        const LOCAL_STORAGE_CONTAINER_TYPES_KEY = 'gic_container_types';
        let containerTypes = ['Glass', 'PET', 'Tetra', 'Bag', 'Other']; // Default types

        // DOM Elements
        const productGrid = document.getElementById('productGrid');
        const cartItemCount = document.getElementById('cartItemCount');
        const cartItemsContainer = document.getElementById('cartItems');
        const emptyCartMessage = document.getElementById('emptyCartMessage');
        const cartButton = document.getElementById('cartButton');
        const cartModal = document.getElementById('cartModal');
        const closeCartButton = document.getElementById('closeCartButton');
        const clearCartButton = document.getElementById('clearCartButton');
        const placeOrderButton = document.getElementById('placeOrderButton');

        const customerLoginSection = document.getElementById('customerLoginSection');
        const shopSection = document.getElementById('shopSection');
        const myOrdersSection = document.getElementById('myOrdersSection');
        const adminSection = document.getElementById('adminSection');

        const customerLoginTabButton = document.getElementById('customerLoginTabButton');
        const shopTabButton = document.getElementById('shopTabButton');
        const myOrdersTabButton = document.getElementById('myOrdersTabButton');
        const adminTabButton = document.getElementById('adminTabButton');
        const customerLogoutButton = document.getElementById('customerLogoutButton');

        const productSearch = document.getElementById('productSearch');
        const categoryFilter = document.getElementById('categoryFilter');

        const customerCodeInput = document.getElementById('customerCodeInput');
        const customerPasswordInput = document.getElementById('customerPasswordInput');
        const customerLoginButton = document.getElementById('customerLoginButton');
        const customerLoginMessage = document.getElementById('customerLoginMessage');
        const customerCodeDisplay = document.getElementById('customerCodeDisplay');

        const ordersList = document.getElementById('ordersList');
        const noOrdersMessage = document.getElementById('noOrdersMessage');

        const adminPasswordInput = document.getElementById('adminPassword');
        const adminLoginButton = document.getElementById('adminLoginButton');
        const adminAuthMessage = document.getElementById('adminAuthMessage');
        const adminContent = document.getElementById('adminContent');

        // Admin Sub-Navigation Elements
        const adminProductsTabButton = document.getElementById('adminProductsTabButton');
        const adminCustomersTabButton = document.getElementById('adminCustomersTabButton');
        const adminProductSection = document.getElementById('adminProductSection');
        const adminCustomerSection = document.getElementById('adminCustomerSection');


        const addProductForm = document.getElementById('addProductForm');
        const newProductNameInput = document.getElementById('newProductName');
        const newProductDescriptionInput = document.getElementById('newProductDescription');
        const newProductCategoryInput = document.getElementById('newProductCategory'); 
        const newProductSKUInput = document.getElementById('newProductSKU'); // SKU is now required
        const newProductTiHiInput = document.getElementById('newProductTiHi'); // New TiHi field
        const newProductCaseWeightInput = document.getElementById('newProductCaseWeight'); // New Case Weight field
        const newProductContainerTypeInput = document.getElementById('newProductContainerType'); // New Container Type dropdown
        const addNewContainerTypeBtn = document.getElementById('addNewContainerTypeBtn'); // Button for new container type
        const newProductPriceInput = document.getElementById('newProductPrice'); // Internal price field
        const addProductMessage = document.getElementById('addProductMessage');
        const discardProductBtn = document.getElementById('discardProductBtn'); 

        const addCustomerForm = document.getElementById('addCustomerForm'); 
        const newCustomerNameInput = document.getElementById('newCustomerName');
        const newCustomerCodeInput = document.getElementById('newCustomerCode');
        const newCustomerPasswordInput = document.getElementById('newCustomerPassword');
        const addCustomerMessage = document.getElementById('addCustomerMessage');
        const discardCustomerBtn = document.getElementById('discardCustomerBtn'); 

        // Quantity Modal Elements
        const quantityModal = document.getElementById('quantityModal');
        const quantityProductName = document.getElementById('quantityProductName');
        const quantityInput = document.getElementById('quantityInput');
        const quantityAddBtn = document.getElementById('quantityAddBtn');
        const quantityCancelBtn = document.getElementById('quantityCancelBtn');
        const quantityError = document.getElementById('quantityError');
        let currentProductIdForQuantity = null; // To store which product is being processed

        // Message Modal Elements
        const messageModal = document.getElementById('messageModal');
        const messageTitle = document.getElementById('messageTitle');
        const messageText = document.getElementById('messageText');
        const messageCloseBtn = document.getElementById('messageCloseBtn');

        const ADMIN_PASSWORD = "281920";
        let isAdminLoggedIn = false;

        /**
         * Shows a custom message modal.
         * @param {string} title - The title of the message.
         * @param {string} text - The body text of the message.
         */
        function showMessageModal(title, text) {
            messageTitle.textContent = title;
            messageText.textContent = text;
            messageModal.classList.add('active');
        }

        /**
         * Hides the custom message modal.
         */
        function hideMessageModal() {
            messageModal.classList.remove('active');
        }

        /**
         * Loads products from Firestore.
         */
        async function loadProductsFromFirestore() {
            if (!window.firebaseDb) {
                console.error("Firestore not initialized for loading products.");
                return;
            }
            try {
                const productsRef = getProductsCollection();
                const querySnapshot = await getDocs(productsRef);
                products = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                products.sort((a, b) => a.name.localeCompare(b.name)); // Keep sorted
                applyFiltersAndSearch(); // Render products after loading
                console.log("Products loaded from Firestore.");
            } catch (error) {
                console.error("Error loading products from Firestore:", error);
                showMessageModal("Error", "Could not load products. Please check console for details.");
            }
        }

        /**
         * Renders the product list on the shop page.
         * Filters `products` based on current search and category.
         */
        function renderProducts() {
            const searchTerm = productSearch.value.toLowerCase().trim();
            const selectedCategory = categoryFilter.value;

            const productsToDisplay = products.filter(product => {
                const matchesSearch = product.name.toLowerCase().includes(searchTerm) ||
                                      product.description.toLowerCase().includes(searchTerm) ||
                                      (product.category && product.category.toLowerCase().includes(searchTerm));
                const matchesCategory = selectedCategory === "All" || (product.category && product.category === selectedCategory);
                return matchesSearch && matchesCategory;
            });

            productGrid.innerHTML = ''; // Clear existing products
            if (productsToDisplay.length === 0) {
                productGrid.innerHTML = '<p class="text-center text-gray-600 text-lg col-span-full">No products found matching your criteria.</p>';
                return;
            }

            productsToDisplay.forEach(product => {
                // Construct the new concatenated description string
                const tiHiDisplay = product.tiHi ? product.tiHi : '';
                const caseWeightDisplay = product.caseWeight ? `${product.caseWeight} lbs` : '';
                const containerTypeDisplay = product.containerType ? product.containerType : '';

                const newDescription = [
                    product.name || '',
                    product.category || '',
                    product.sku || '',
                    tiHiDisplay,
                    caseWeightDisplay,
                    containerTypeDisplay
                ].filter(Boolean).join(' | '); // Filter(Boolean) removes empty strings

                const productListItem = `
                    <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 p-4 flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">${product.name}</h3>
                            <p class="text-gray-600 text-sm">${newDescription}</p>
                        </div>
                        <button class="add-to-cart-btn bg-blue-500 text-white py-2 px-3 rounded-lg shadow-md hover:bg-blue-600 transition duration-300 text-sm font-medium" data-product-id="${product.id}" data-product-name="${product.name}">
                            Add to Cart
                        </button>
                    </div>
                `;
                productGrid.insertAdjacentHTML('beforeend', productListItem);
            });

            // Add event listeners to "Add to Cart" buttons after they are rendered
            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const productId = event.target.dataset.productId;
                    const productName = event.target.dataset.productName;
                    showQuantityModal(productId, productName);
                });
            });
        }

        /**
         * Adds a product to the cart with a specified quantity.
         * @param {string} productId - The ID of the product to add.
         * @param {number} quantity - The number of cases to add.
         */
        function addToCartWithQuantity(productId, quantity) {
            const product = products.find(p => p.id === productId);
            if (product && quantity > 0) {
                const existingItem = cart.find(item => item.product.id === productId);
                if (existingItem) {
                    existingItem.quantity += quantity;
                } else {
                    cart.push({ product: product, quantity: quantity });
                }
                updateCartDisplay();
                hideQuantityModal(); // Hide the quantity modal after adding
                showMessageModal("Item Added", `${quantity} cases of ${product.name} added to cart!`);
            } else {
                showMessageModal("Error", "Could not add item to cart. Invalid quantity.");
            }
        }

        // Function to remove an item from the cart
        function removeFromCart(productId) {
            cart = cart.filter(item => item.product.id !== productId);
            updateCartDisplay();
        }

        // Function to update cart item quantity
        function updateQuantity(productId, change) {
            const item = cart.find(item => item.product.id === productId);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    removeFromCart(productId); // Remove if quantity drops to 0 or less
                } else {
                    updateCartDisplay();
                }
            }
        }

        // Function to update the cart display (items, total, count)
        function updateCartDisplay() {
            cartItemsContainer.innerHTML = ''; // Clear current cart items
            let itemCount = 0;

            if (cart.length === 0) {
                emptyCartMessage.classList.remove('hidden');
            } else {
                emptyCartMessage.classList.add('hidden');
                cart.forEach(item => {
                    itemCount += item.quantity;

                    const cartItemHtml = `
                        <div class="flex items-center justify-between border-b border-gray-100 py-3 last:border-b-0">
                            <div class="flex-grow">
                                <p class="font-medium text-gray-800">${item.product.name}</p>
                                <p class="text-sm text-gray-500">Cases: ${item.quantity}</p>
                            </div>
                            <div class="flex items-center">
                                <button class="quantity-btn bg-gray-200 text-gray-700 w-8 h-8 rounded-full flex items-center justify-center hover:bg-gray-300 transition" data-product-id="${item.product.id}" data-change="-1">-</button>
                                <span class="mx-2 font-semibold text-gray-800">${item.quantity}</span>
                                <button class="quantity-btn bg-gray-200 text-gray-700 w-8 h-8 rounded-full flex items-center justify-center hover:bg-gray-300 transition" data-product-id="${item.product.id}" data-change="1">+</button>
                                <button class="remove-from-cart-btn text-red-500 hover:text-red-700 ml-4 text-2xl" data-product-id="${item.product.id}">&times;</button>
                            </div>
                        </div>
                    `;
                    cartItemsContainer.insertAdjacentHTML('beforeend', cartItemHtml);
                });
            }

            cartItemCount.textContent = itemCount;

            // Re-add event listeners for quantity and remove buttons (since they are re-rendered)
            document.querySelectorAll('.quantity-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const productId = event.target.dataset.productId;
                    const change = parseInt(event.target.dataset.change);
                    updateQuantity(productId, change);
                });
            });

            document.querySelectorAll('.remove-from-cart-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const productId = event.target.dataset.productId;
                    removeFromCart(productId);
                });
            });
        }

        // Function to place an order
        async function placeOrder() {
            if (!currentLoggedInCustomerCode) {
                showMessageModal("Error", "Please log in as a customer to place an order.");
                return;
            }
            if (cart.length === 0) {
                showMessageModal("Empty Cart", "Your cart is empty. Add items before placing an order.");
                return;
            }

            if (!window.firebaseDb) {
                showMessageModal("Error", "Database not initialized. Cannot place order.");
                return;
            }

            try {
                const orderItems = cart.map(item => ({
                    productId: item.product.id,
                    name: item.product.name,
                    quantity: item.quantity,
                    price: item.product.price // Keep price for order record
                }));
                const totalPrice = orderItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);

                const ordersRef = getOrdersCollection(currentLoggedInCustomerCode);
                await addDoc(ordersRef, {
                    customerCode: currentLoggedInCustomerCode,
                    orderDate: serverTimestamp(), // Firestore's server timestamp
                    items: orderItems,
                    totalPrice: totalPrice,
                    status: "Pending"
                });

                cart = []; // Clear cart after placing order
                updateCartDisplay();
                hideCartModal();
                showMessageModal("Order Placed!", "Your order has been successfully placed. You can view it in 'My Orders'.");
                loadPreviousOrders(); // Refresh orders list
            } catch (error) {
                console.error("Error placing order:", error);
                showMessageModal("Order Error", "Failed to place order. Please try again.");
            }
        }


        // Function to show the cart modal
        function showCartModal() {
            cartModal.classList.remove('hidden');
            // Animate by sliding in from the right
            setTimeout(() => {
                cartContent.classList.remove('translate-x-full');
                cartContent.classList.add('translate-x-0');
            }, 10); // Small delay to allow 'hidden' to be removed first
        }

        // Function to hide the cart modal
        function hideCartModal() {
            // Animate by sliding out to the right
            cartContent.classList.remove('translate-x-0');
            cartContent.classList.add('translate-x-full');
            setTimeout(() => {
                cartModal.classList.add('hidden');
            }, 300); // Match animation duration
        }

        // Function to show the quantity selection modal
        function showQuantityModal(productId, productName) {
            currentProductIdForQuantity = productId;
            quantityProductName.textContent = productName;
            quantityInput.value = 1; // Default to 1 case
            quantityError.classList.add('hidden'); // Hide any previous errors
            quantityModal.classList.add('active'); // Shows modal and triggers transition
            quantityInput.focus(); // Focus the input for immediate typing
        }

        // Function to hide the quantity selection modal
        function hideQuantityModal() {
            quantityModal.classList.remove('active'); // Hides modal and triggers transition
            setTimeout(() => {
                quantityModal.classList.add('hidden');
                currentProductIdForQuantity = null; // Clear the stored product ID
            }, 200); // Match transition duration
        }

        // Function to handle filtering and searching
        function applyFiltersAndSearch() {
            renderProducts(); // Calling renderProducts without arguments will trigger filtering
        }

        /**
         * Controls tab visibility.
         * @param {HTMLElement} activeSection - The section to show.
         * @param {HTMLElement} activeTabButton - The tab button to highlight.
         */
        function switchTab(activeSection, activeTabButton) {
            // Hide all sections
            customerLoginSection.classList.add('hidden');
            shopSection.classList.add('hidden');
            myOrdersSection.classList.add('hidden');
            adminSection.classList.add('hidden');

            // Deactivate all tab buttons
            customerLoginTabButton.classList.remove('bg-blue-100');
            shopTabButton.classList.remove('bg-blue-100');
            myOrdersTabButton.classList.remove('bg-blue-100');
            adminTabButton.classList.remove('bg-blue-100');

            // Show active section and highlight active tab
            activeSection.classList.remove('hidden');
            activeTabButton.classList.add('bg-blue-100');
        }

        // Show Customer Login section initially
        function showLoginSection() {
            switchTab(customerLoginSection, customerLoginTabButton);
            // Hide shop-related buttons for non-logged-in customers
            shopTabButton.classList.add('hidden');
            myOrdersTabButton.classList.add('hidden');
            cartButton.classList.add('hidden');
            customerLogoutButton.classList.add('hidden');
            currentLoggedInCustomerCode = null; // Ensure customer is logged out logically
            customerLoginMessage.classList.add('hidden'); // Hide any login messages
            customerCodeInput.value = '';
            customerPasswordInput.value = '';
            updateCartDisplay(); // Clear cart display on logout
        }

        // Show Shop section (only if logged in as customer)
        function showShopSection() {
            if (!currentLoggedInCustomerCode) {
                showMessageModal("Access Denied", "Please log in as a customer to access the shop.");
                showLoginSection();
                return;
            }
            switchTab(shopSection, shopTabButton);
            productSearch.value = ''; // Clear search when switching tabs
            categoryFilter.value = 'All'; // Reset category filter
            applyFiltersAndSearch(); // Re-render all products with filters applied
        }

        // Show My Orders section (only if logged in as customer)
        async function showMyOrdersSection() {
            if (!currentLoggedInCustomerCode) {
                showMessageModal("Access Denied", "Please log in as a customer to view your orders.");
                showLoginSection();
                return;
            }
            switchTab(myOrdersSection, myOrdersTabButton);
            await loadPreviousOrders();
        }

        // Show Admin section and handle authentication
        function showAdminSection() {
            switchTab(adminSection, adminTabButton);

            if (isAdminLoggedIn) {
                adminAuth.classList.add('hidden');
                adminContent.classList.remove('hidden');
                showAdminProductSection(); // Default to showing product section after admin login
            } else {
                adminAuth.classList.remove('hidden');
                adminContent.classList.add('hidden');
                adminAuthMessage.classList.add('hidden'); // Hide any previous error messages
                adminPasswordInput.value = ''; // Clear password field
            }
        }

        // Admin Sub-Tab Functions
        function showAdminProductSection() {
            adminProductSection.classList.remove('hidden');
            adminCustomerSection.classList.add('hidden');
            adminProductsTabButton.classList.remove('bg-gray-200');
            adminProductsTabButton.classList.add('bg-blue-500', 'text-white');
            adminCustomersTabButton.classList.remove('bg-blue-500', 'text-white');
            adminCustomersTabButton.classList.add('bg-gray-200');
            addProductMessage.classList.add('hidden'); // Hide messages when switching
            addProductForm.reset(); // Clear form on tab switch
        }

        function showAdminCustomerSection() {
            adminCustomerSection.classList.remove('hidden');
            adminProductSection.classList.add('hidden');
            adminCustomersTabButton.classList.remove('bg-gray-200');
            adminCustomersTabButton.classList.add('bg-blue-500', 'text-white');
            adminProductsTabButton.classList.remove('bg-blue-500', 'text-white');
            adminProductsTabButton.classList.add('bg-gray-200');
            addCustomerMessage.classList.add('hidden'); // Hide messages when switching
            addCustomerForm.reset(); // Clear form on tab switch
        }


        // Admin login check
        function checkAdminPassword() {
            if (adminPasswordInput.value === ADMIN_PASSWORD) {
                isAdminLoggedIn = true;
                adminAuthMessage.classList.add('hidden');
                adminAuth.classList.add('hidden');
                adminContent.classList.remove('hidden');
                showAdminProductSection(); // Default to showing product section after admin login
            } else {
                isAdminLoggedIn = false;
                adminAuthMessage.classList.remove('hidden');
                adminAuthMessage.textContent = 'Incorrect password.';
            }
        }

        /**
         * Handles customer login.
         */
        async function handleCustomerLogin() {
            const code = customerCodeInput.value.trim();
            const password = customerPasswordInput.value.trim();

            if (!code || !password) {
                customerLoginMessage.textContent = "Please enter both customer code and password.";
                customerLoginMessage.classList.remove('hidden');
                return;
            }

            if (!window.firebaseDb) {
                customerLoginMessage.textContent = "Database not initialized. Cannot log in.";
                customerLoginMessage.classList.remove('hidden');
                return;
            }

            try {
                const customersRef = getCustomersCollection();
                const q = query(customersRef, where("customerCode", "==", code));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    customerLoginMessage.textContent = "Invalid customer code or password.";
                    customerLoginMessage.classList.remove('hidden');
                    return;
                }

                const customerDoc = querySnapshot.docs[0];
                const customerData = customerDoc.data();

                // IMPORTANT: For a real app, passwords should be securely hashed and compared on a backend.
                // This is simplified for a "simple" client-side example.
                if (customerData.password === password) {
                    currentLoggedInCustomerCode = customerData.customerCode;
                    customerLoginMessage.classList.add('hidden');
                    customerCodeInput.value = '';
                    customerPasswordInput.value = '';

                    // Show customer-specific tabs and buttons
                    shopTabButton.classList.remove('hidden');
                    myOrdersTabButton.classList.remove('hidden');
                    cartButton.classList.remove('hidden');
                    customerLogoutButton.classList.remove('hidden');
                    customerLoginTabButton.classList.add('hidden'); // Hide customer login tab when logged in
                    customerCodeDisplay.textContent = currentLoggedInCustomerCode;

                    showShopSection(); // Redirect to shop after login
                    showMessageModal("Welcome!", `Logged in as ${customerData.name || customerData.customerCode}.`);
                } else {
                    customerLoginMessage.textContent = "Invalid customer code or password.";
                    customerLoginMessage.classList.remove('hidden');
                }
            }
             catch (error) {
                console.error("Error during customer login:", error);
                customerLoginMessage.textContent = "An error occurred during login. Please try again.";
                customerLoginMessage.classList.remove('hidden');
            }
        }

        /**
         * Logs out the current customer.
         */
        async function handleCustomerLogout() {
            currentLoggedInCustomerCode = null;
            cart = []; // Clear cart on logout
            updateCartDisplay();
            showMessageModal("Logged Out", "You have been successfully logged out.");
            showLoginSection(); // Go back to login screen
        }

        /**
         * Loads previous orders for the current logged-in customer.
         */
        async function loadPreviousOrders() {
            ordersList.innerHTML = ''; // Clear existing orders
            noOrdersMessage.classList.add('hidden'); // Hide message initially

            if (!currentLoggedInCustomerCode) {
                ordersList.innerHTML = '<p class="text-center text-gray-600 text-lg">Please log in to view orders.</p>';
                return;
            }

            if (!window.firebaseDb) {
                ordersList.innerHTML = '<p class="text-center text-gray-600 text-lg text-red-500">Database not initialized. Cannot load orders.</p>';
                return;
            }

            try {
                const ordersRef = getOrdersCollection(currentLoggedInCustomerCode);
                // Use imported documentId function directly
                const q = query(ordersRef); 
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    noOrdersMessage.classList.remove('hidden');
                } else {
                    querySnapshot.docs.forEach(orderDoc => {
                        const orderData = orderDoc.data();
                        const orderId = orderDoc.id;
                        const orderDate = orderData.orderDate ? new Date(orderData.orderDate.toDate()).toLocaleString() : 'N/A';
                        const orderTotal = orderData.totalPrice ? orderData.totalPrice.toFixed(2) : '0.00';

                        let itemsHtml = orderData.items.map(item => `
                            <li>${item.name} (Cases: ${item.quantity})</li>
                        `).join('');

                        const orderCard = `
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h3 class="text-xl font-semibold text-gray-900 mb-2">Order ID: ${orderId}</h3>
                                <p class="text-gray-600 text-sm mb-2">Date: ${orderDate}</p>
                                <p class="text-gray-700 font-medium mb-3">Total: $${orderTotal}</p>
                                <ul class="list-disc list-inside text-gray-700 text-sm mb-4">
                                    ${itemsHtml}
                                </ul>
                                <button class="duplicate-order-btn bg-purple-500 text-white py-2 px-4 rounded-lg shadow-md hover:bg-purple-600 transition duration-300 text-sm font-medium" data-order-id="${orderId}">
                                    Duplicate Order to Cart
                                </button>
                            </div>
                        `;
                        ordersList.insertAdjacentHTML('beforeend', orderCard);
                    });

                    // Add event listeners for duplicate order buttons
                    document.querySelectorAll('.duplicate-order-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const orderIdToDuplicate = event.target.dataset.orderId;
                            duplicateOrderToCart(orderIdToDuplicate);
                        });
                    });
                }
            } catch (error) {
                console.error("Error loading previous orders:", error);
                ordersList.innerHTML = '<p class="text-center text-red-500 text-lg">Failed to load orders. Please try again.</p>';
            }
        }

        /**
         * Duplicates a previous order's items into the current cart.
         * @param {string} orderId - The ID of the order to duplicate.
         */
        async function duplicateOrderToCart(orderId) {
            if (!currentLoggedInCustomerCode || !window.firebaseDb) {
                showMessageModal("Error", "Not logged in or database not ready.");
                return;
            }

            try {
                const ordersRef = getOrdersCollection(currentLoggedInCustomerCode);
                // Use imported documentId function directly in the query
                const q = query(ordersRef, where(documentId(), '==', orderId));
                const orderSnapshot = await getDocs(q);
                
                if (orderSnapshot.empty) {
                    showMessageModal("Error", "Order not found.");
                    return;
                }

                const orderData = orderSnapshot.docs[0].data();
                orderData.items.forEach(orderItem => {
                    // Find the actual product object from our global 'products' list
                    const productInStore = products.find(p => p.id === orderItem.productId);
                    if (productInStore) {
                        const existingCartItem = cart.find(item => item.product.id === productInStore.id);
                        if (existingCartItem) {
                            existingCartItem.quantity += orderItem.quantity;
                        } else {
                            cart.push({ product: productInStore, quantity: orderItem.quantity });
                        }
                    } else {
                        console.warn(`Product with ID ${orderItem.productId} from order ${orderId} not found in current product list.`);
                    }
                });
                updateCartDisplay();
                showMessageModal("Order Duplicated", `Items from order ${orderId} added to your cart.`);
                showCartModal(); // Show the cart after duplicating
            } catch (error) {
                console.error("Error duplicating order:", error);
                showMessageModal("Error", "Failed to duplicate order. Please try again.");
            }
        }

        // Add new product function (Firestore integration)
        async function addNewProduct(event) {
            event.preventDefault();

            if (!window.firebaseDb) {
                addProductMessage.textContent = "Database not initialized. Cannot add product.";
                addProductMessage.classList.remove('hidden');
                addProductMessage.classList.add('text-red-500');
                return;
            }

            const name = newProductNameInput.value.trim();
            const description = newProductDescriptionInput.value.trim();
            const category = newProductCategoryInput.value; 
            const sku = newProductSKUInput.value.trim(); // SKU is now required
            const tiHi = newProductTiHiInput.value.trim(); // New TiHi
            const caseWeight = parseFloat(newProductCaseWeightInput.value); // New Case Weight
            const containerType = newProductContainerTypeInput.value; // New Container Type
            const price = parseFloat(newProductPriceInput.value); // Internal price field

            // Basic validation for new required fields
            if (!name || !category || !sku || isNaN(price) || price < 0 || !containerType) {
                addProductMessage.textContent = 'Please fill all required fields (Name, Category, SKU, Container Type) and ensure price is valid.';
                addProductMessage.classList.remove('hidden');
                addProductMessage.classList.remove('text-green-600'); 
                addProductMessage.classList.add('text-red-500'); 
                setTimeout(() => addProductMessage.classList.add('hidden'), 5000); // More time for longer message
                return;
            }
            if (isNaN(caseWeight) || caseWeight < 0) {
                 addProductMessage.textContent = 'Please enter a valid Case Weight (0 or greater).';
                addProductMessage.classList.remove('hidden');
                addProductMessage.classList.remove('text-green-600'); 
                addProductMessage.classList.add('text-red-500'); 
                setTimeout(() => addProductMessage.classList.add('hidden'), 3000);
                return;
            }


            try {
                const productsRef = getProductsCollection();
                // Generate a new ID or use a custom one if SKU can be ID
                const newProductId = 'p' + (products.length > 0 ? (Math.max(...products.map(p => parseInt(p.id.substring(1)))) + 1) : 1);

                const productData = {
                    id: newProductId,
                    name: name,
                    description: description,
                    category: category, 
                    sku: sku, // Included required SKU
                    tiHi: tiHi, // Included TiHi
                    caseWeight: caseWeight, // Included Case Weight
                    containerType: containerType, // Included Container Type
                    price: price, 
                };
                await setDoc(doc(productsRef, newProductId), productData); // Use setDoc with custom ID

                await loadProductsFromFirestore(); // Reload products to update the shop view
                
                addProductForm.reset();
                addProductMessage.textContent = 'Product added successfully!';
                addProductMessage.classList.remove('hidden');
                addProductMessage.classList.remove('text-red-500'); 
                addProductMessage.classList.add('text-green-600');
                setTimeout(() => addProductMessage.classList.add('hidden'), 3000);
            } catch (error) {
                console.error("Error adding new product:", error);
                addProductMessage.textContent = 'Failed to add product. Please try again.';
                addProductMessage.classList.remove('hidden');
                addProductMessage.classList.remove('text-green-600');
                addProductMessage.classList.add('text-red-500');
                setTimeout(() => addProductMessage.classList.add('hidden'), 3000);
            }
        }

        // Add new customer function (Firestore integration)
        async function addNewCustomer(event) {
            event.preventDefault();

            if (!window.firebaseDb) {
                addCustomerMessage.textContent = "Database not initialized. Cannot add customer.";
                addCustomerMessage.classList.remove('hidden');
                addCustomerMessage.classList.add('text-red-500');
                return;
            }

            const name = newCustomerNameInput.value.trim();
            const code = newCustomerCodeInput.value.trim();
            const password = newCustomerPasswordInput.value.trim(); // Storing plaintext for simplicity, NOT for production

            if (!name || !code || !password) {
                addCustomerMessage.textContent = 'Please fill all customer fields.';
                addCustomerMessage.classList.remove('hidden');
                addCustomerMessage.classList.remove('text-green-600');
                addCustomerMessage.classList.add('text-red-500');
                setTimeout(() => addCustomerMessage.classList.add('hidden'), 3000);
                return;
            }

            try {
                const customersRef = getCustomersCollection();
                // Check if customer code already exists
                const q = query(customersRef, where("customerCode", "==", code));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    addCustomerMessage.textContent = 'Customer code already exists. Please choose a different one.';
                    addCustomerMessage.classList.remove('hidden');
                    addCustomerMessage.classList.remove('text-green-600');
                    addCustomerMessage.classList.add('text-red-500');
                    setTimeout(() => addCustomerMessage.classList.add('hidden'), 3000);
                    return;
                }

                await addDoc(customersRef, {
                    name: name,
                    customerCode: code,
                    password: password // IMPORTANT: In production, HASH this password securely!
                });
                
                addCustomerForm.reset();
                addCustomerMessage.textContent = 'Customer added successfully!';
                addCustomerMessage.classList.remove('hidden');
                addCustomerMessage.classList.remove('text-red-500'); 
                addCustomerMessage.classList.add('text-green-600');
                setTimeout(() => addCustomerMessage.classList.add('hidden'), 3000);
            } catch (error) {
                console.error("Error adding new customer:", error);
                addCustomerMessage.textContent = 'Failed to add customer. Please try again.';
                addCustomerMessage.classList.remove('hidden');
                addCustomerMessage.classList.remove('text-green-600');
                addCustomerMessage.classList.add('text-red-500');
                setTimeout(() => addCustomerMessage.classList.add('hidden'), 3000);
            }
        }

        // --- Container Type Management Functions ---

        /**
         * Loads container types from local storage or uses default.
         */
        function loadContainerTypes() {
            const storedTypes = localStorage.getItem(LOCAL_STORAGE_CONTAINER_TYPES_KEY);
            if (storedTypes) {
                containerTypes = JSON.parse(storedTypes);
            }
            populateContainerTypesDropdown();
        }

        /**
         * Saves container types to local storage.
         */
        function saveContainerTypes() {
            localStorage.setItem(LOCAL_STORAGE_CONTAINER_TYPES_KEY, JSON.stringify(containerTypes));
        }

        /**
         * Populates the container types dropdown.
         * @param {string} selectedValue - The value to mark as selected (optional).
         */
        function populateContainerTypesDropdown(selectedValue = '') {
            newProductContainerTypeInput.innerHTML = ''; // Clear existing options

            // Add default "Select a type" option if no value is pre-selected
            if (!selectedValue) {
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = "Select a type";
                defaultOption.disabled = true;
                defaultOption.selected = true;
                newProductContainerTypeInput.appendChild(defaultOption);
            }

            containerTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                if (type === selectedValue) {
                    option.selected = true;
                }
                newProductContainerTypeInput.appendChild(option);
            });
        }

        /**
         * Handles adding a new container type via prompt.
         */
        function handleAddNewContainerType() {
            const newType = prompt("Enter new container type (e.g., 'Cans', 'Bottles'):");
            if (newType && newType.trim() !== '') {
                const trimmedType = newType.trim();
                if (!containerTypes.includes(trimmedType)) {
                    containerTypes.push(trimmedType);
                    containerTypes.sort(); // Keep sorted alphabetically
                    saveContainerTypes();
                    populateContainerTypesDropdown(trimmedType); // Re-populate and select new type
                    showMessageModal("Success", `"${trimmedType}" added to container types.`);
                } else {
                    showMessageModal("Info", `"${trimmedType}" already exists in container types.`);
                }
            }
        }


        // Event Listeners
        cartButton.addEventListener('click', showCartModal);
        closeCartButton.addEventListener('click', hideCartModal);
        clearCartButton.addEventListener('click', () => {
            cart = [];
            updateCartDisplay();
            showMessageModal("Cart Cleared", "Your shopping cart has been emptied.");
        });
        placeOrderButton.addEventListener('click', placeOrder);

        productSearch.addEventListener('input', applyFiltersAndSearch);
        categoryFilter.addEventListener('change', applyFiltersAndSearch);

        customerLoginTabButton.addEventListener('click', showLoginSection);
        shopTabButton.addEventListener('click', showShopSection);
        myOrdersTabButton.addEventListener('click', showMyOrdersSection);
        adminTabButton.addEventListener('click', showAdminSection);
        customerLogoutButton.addEventListener('click', handleCustomerLogout);

        customerLoginButton.addEventListener('click', handleCustomerLogin);
        customerCodeInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleCustomerLogin(); });
        customerPasswordInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleCustomerLogin(); });

        adminLoginButton.addEventListener('click', checkAdminPassword);
        adminPasswordInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                checkAdminPassword();
            }
        });

        // Admin Sub-Tab Event Listeners
        adminProductsTabButton.addEventListener('click', showAdminProductSection);
        adminCustomersTabButton.addEventListener('click', showAdminCustomerSection);


        addProductForm.addEventListener('submit', addNewProduct);
        addCustomerForm.addEventListener('submit', addNewCustomer); // New event listener for customer form

        // Discard Buttons Event Listeners
        discardProductBtn.addEventListener('click', () => {
            addProductForm.reset();
            addProductMessage.classList.add('hidden'); // Hide messages
            populateContainerTypesDropdown(); // Reset container type dropdown
        });

        discardCustomerBtn.addEventListener('click', () => {
            addCustomerForm.reset();
            addCustomerMessage.classList.add('hidden'); // Hide messages
        });

        // New container type button event listener
        addNewContainerTypeBtn.addEventListener('click', handleAddNewContainerType);


        // Quantity Modal Event Listeners
        quantityAddBtn.addEventListener('click', () => {
            const quantity = parseInt(quantityInput.value);
            if (currentProductIdForQuantity && !isNaN(quantity) && quantity >= 1) {
                addToCartWithQuantity(currentProductIdForQuantity, quantity);
                quantityError.classList.add('hidden');
            } else {
                quantityError.classList.remove('hidden');
                quantityError.textContent = 'Please enter a valid quantity (1 or more).';
            }
        });
        quantityInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                quantityAddBtn.click();
            }
        });
        quantityCancelBtn.addEventListener('click', hideQuantityModal);

        // Message Modal Event Listener
        messageCloseBtn.addEventListener('click', hideMessageModal);


        // Initialize the store
        document.addEventListener('DOMContentLoaded', async () => {
            // Seed initial products and customers (if Firebase is initialized)
            if (window.firebaseApp) {
                // IMPORTANT: Ensure anonymous sign-in is complete before seeding data.
                // This ensures `request.auth` is not null for initial Firestore operations.
                if (!window.firebaseAuth.currentUser) {
                    try {
                        await signInAnonymously(window.firebaseAuth);
                        console.log("Anonymous sign-in confirmed before DOMContentLoaded operations.");
                    } catch (error) {
                        console.error("Failed to sign in anonymously on DOMContentLoaded:", error);
                        showMessageModal("Error", "Failed to connect to authentication service. Some features may not work.");
                    }
                }
                await seedInitialData(); // Call the combined seeding function
            } else {
                // Fallback if Firebase isn't configured, products remain hardcoded
                console.warn("Firebase not fully initialized. Using hardcoded products. Persistence and customer features will not work.");
                renderProducts();
            }
            loadContainerTypes(); // Load container types for the dropdown
            showLoginSection(); // Start on the customer login section
            updateCartDisplay(); // Initialize cart display
        });
    </script>
</body>
</html>
